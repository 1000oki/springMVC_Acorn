<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cafe">

	<sql id="searchCondition">
      <choose>
         <when test="title != null and content != null">
            WHERE title LIKE '%'||#{title}||'%' OR content LIKE '%'||#{content}||'%'
         </when>
         <when test="title != null">
            WHERE title LIKE '%'||#{title}||'%'
         </when>
         <when test="writer != null">
            WHERE writer LIKE '%'||#{writer}||'%'
         </when>
      </choose>
     </sql>
	
	<!-- 
		xml문서는 '<' '>' 기호에 굉장히 예민함.
		크다 작다를 표현하기 위해서는 >,< 기호가 필요함. 그냥 ><를 사용하면 에러가 발생함.
		<![CDATA[ ... ]]> ...에 >,< 기호를 넣어도 아무 상관없음(에러 발생x).
	 -->
	<select id="getList" parameterType="cafeDto" resultType="cafeDto">
       SELECT *
       FROM
          (SELECT result1.*, ROWNUM AS rnum
          FROM
             (SELECT num,writer,title,content,viewCount,regdate
             FROM board_cafe
             <include refid="searchCondition"/>
             ORDER BY num DESC) result1)
       <![CDATA[ 
       WHERE rnum >= #{startRowNum} AND rnum <= #{endRowNum}
       ]]>
   	</select>
   
   <select id="getCount" parameterType="cafeDto" resultType="int">
      SELECT NVL(MAX(ROWNUM), 0)
      FROM board_cafe
      <include refid="searchCondition"/>
   </select>   

	<insert id="insert" parameterType="cafeDto">
		INSERT INTO board_cafe
		(num, writer, title, content, viewCount, regdate)
		VALUES(board_cafe_seq.NEXTVAL, #{writer}, #{title}, #{content}, #{viewCount}, SYSDATE)
	</insert>
	
	<select id="getData" parameterType="int" resultType="cafeDto">
		SELECT num, writer, title, content, viewCount, TO_CHAR(regdate, 'YY.MM.DD HH24:MI') AS regdate
		FROM board_cafe
		WHERE num=#{num}
	</select>
	
	<update id="addViewCount" parameterType="int">
		UPDATE board_cafe
		SET viewCount = viewCount+1
		WHERE num = #{num}
	</update>
	
	<delete id="delete" parameterType="int">
		DELETE FROM board_cafe
		WHERE num=#{num}
	</delete>
	
	<!-- 
		#{ } 대신 ${ }도 가능!
		el이 아니라 mybatis에서 관리하는 것임.
		실행하기 전에 ${}안에 들어 있는 값으로 출력을 해놓고 바뀌는 전처리임. (보안 이슈가 있음)
	 -->
	<update id="update" parameterType="cafeDto">
		UPDATE board_cafe
		SET title=#{title}, content='${content}'
		WHERE num=#{num}
	</update>
</mapper>